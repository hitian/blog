<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>lottery on 哈哈哈</title><link>https://hitian.info/tags/lottery/</link><description>Recent content in lottery on 哈哈哈</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Wed, 23 Nov 2011 00:00:00 +0000</lastBuildDate><atom:link href="https://hitian.info/tags/lottery/index.xml" rel="self" type="application/rss+xml"/><item><title>使用类似于奖池方式的抽奖模拟</title><link>https://hitian.info/post/lottery-simulation/</link><pubDate>Wed, 23 Nov 2011 00:00:00 +0000</pubDate><guid>https://hitian.info/post/lottery-simulation/</guid><description>一般来说要做一个抽奖程序会立即想到用随机数. 但是通常情况下随机数也不是那么的随机, 数量比较大的时候才能体现出比较平均, 数量较小的时候中奖概率的可控性将会很差. 一不小心多被抽中几个麻烦就大了.
&amp;lt;?php class T_prize{ var $item; var $table; /** * 抽奖主程序 外部调用入口 * @param unknown_type $db 数据库链接 * @param unknown_type $id 抽奖类型 */ function prize($db, $id){ global $prize_set; // if(!isset($prize_set[$id])){ return false; } $this-&amp;gt;item = $prize_set[$id]; $table = &amp;#39;my_prize_store_table_&amp;#39; . $id; //抽奖并发较大时可以进行分表, 多生成几个奖池 //$table = &amp;#39;my_prize_store_table_&amp;#39; . $id . &amp;#39;_&amp;#39; . rand(0, 4); $this-&amp;gt;table = $table; //防止多个用户抽到同一个条目, 进行锁表 $db-&amp;gt;query(&amp;#34;lock table &amp;#34; . $table . &amp;#34; write&amp;#34;); $pid = $this-&amp;gt;get_one($db, $id); //奖池中没有奖品时重新初始化奖池 if($pid == &amp;#39;-1&amp;#39;){ $this-&amp;gt;create_pool($db, $id); $pid = $this-&amp;gt;get_one($db, $id); } //释放锁 返回抽奖结果 $db-&amp;gt;query(&amp;#34;unlock table&amp;#34;); return $pid; } /** * 抽奖一次 * @param unknown_type $db * @param unknown_type $id */ function get_one($db, $id){ $table = $this-&amp;gt;table; $sql = &amp;#34;SELECT * FROM ${table} WHERE enable = &amp;#39;1&amp;#39; LIMIT 1&amp;#34;; $row = $db-&amp;gt;fetch($db-&amp;gt;query($sql)); $success = false; $re = array(); if($row){ $id = $row[&amp;#39;id&amp;#39;]; $pid = $row[&amp;#39;pid&amp;#39;]; $update_data = array( &amp;#39;enable&amp;#39; =&amp;gt; 0, ); $db-&amp;gt;update($table, $update_data, &amp;#34;id=&amp;#39;$id&amp;#39;&amp;#34;); $result = $db-&amp;gt;getAffectedRows(); if($result &amp;gt; 0){ $success = true; $re = $row; }else{ my_log(&amp;#39;抽奖池条目状态修改发生错误 id:&amp;#39; .</description></item></channel></rss>