<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>database on 不折腾不舒服</title><link>https://hitian.info/categories/database/</link><description>Recent content in database on 不折腾不舒服</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Tue, 12 Jul 2011 00:00:00 +0000</lastBuildDate><atom:link href="https://hitian.info/categories/database/index.xml" rel="self" type="application/rss+xml"/><item><title>简单的mysql表级锁</title><link>https://hitian.info/post/simple-mysql-table-level-locks/</link><pubDate>Tue, 12 Jul 2011 00:00:00 +0000</pubDate><guid>https://hitian.info/post/simple-mysql-table-level-locks/</guid><description>由于业务需要, 一个表不允许两个及以上用户同时操作.由于是mysql4.1 事务等高级特性就不用想了, 存储引擎统一使用的MyISAM.其实转换成InnoDB 就可以使用行级锁了, 但是由于是线上正在使用的数据库, 数据量比较大,转换怕出现意外. 要实现的功能又是在后台使用. 所以就直接使用表级锁完全可以了.在mysql中对表加锁和解锁其实挺简单的
LOCKTABLEtable_name;UNLOCKTABLE;demo
&amp;lt;?php $db = new Mysql(); $db-&amp;gt;open(); $db-&amp;gt;query(&amp;#34;lock table &amp;#34; . $table); $sql = &amp;#34;SELECT * FROM ${table}WHERE gid=&amp;#39;${gid}&amp;#39; AND sid IS NULL LIMIT 1&amp;#34;; $row = $db-&amp;gt;fetch($db-&amp;gt;query($sql)); $success = false; $re = array(); if($row){ $id = $row[&amp;#39;id&amp;#39;]; $update_data = array( &amp;#39;udate&amp;#39; =&amp;gt; date(&amp;#39;Y-m-d H:i:s&amp;#39;), &amp;#39;tuid&amp;#39; =&amp;gt; $uid, &amp;#39;operator&amp;#39; =&amp;gt; $_COOKIE[&amp;#39;admin_name&amp;#39;], &amp;#39;sid&amp;#39; =&amp;gt; $sid, ); $db-&amp;gt;update($this-&amp;gt;table, $update_data, &amp;#34;id=&amp;#39;$id&amp;#39;&amp;#34;); $result = $db-&amp;gt;getAffectedRows(); if($result &amp;gt; 0){ $success = true; $re = $row; }else{ $msg = &amp;#39;发生错误: 物品库存修改失败!</description></item></channel></rss>