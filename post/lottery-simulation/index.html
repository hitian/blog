<!doctype html><html lang=zh-cn>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="一般来说要做一个抽奖程序会立即想到用随机数. 但是通常情况下随机数也不是那么的随机, 数量比较大的时候才能体现出比较平均, 数量较小的时候中奖概率的可控性将会很差. 一不小心多被抽中几个麻烦就大了.
&amp;lt;?php class T_prize{ var $item; var $table; /** * 抽奖主程序 外部调用入口 * @param unknown_type $db 数据库链接 * @param unknown_type $id 抽奖类型 */ function prize($db, $id){ global $prize_set; //  if(!isset($prize_set[$id])){ return false; } $this-&amp;gt;item = $prize_set[$id]; $table = &amp;#39;my_prize_store_table_&amp;#39; . $id; //抽奖并发较大时可以进行分表, 多生成几个奖池  //$table = &amp;#39;my_prize_store_table_&amp;#39; . $id . &amp;#39;_&amp;#39; . rand(0, 4);  $this-&amp;gt;table = $table; //防止多个用户抽到同一个条目, 进行锁表  $db-&amp;gt;query(&amp;#34;lock table &amp;#34; . $table ."><title>使用类似于奖池方式的抽奖模拟</title>
<link rel=canonical href=https://hitian.info/post/lottery-simulation/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="使用类似于奖池方式的抽奖模拟">
<meta property="og:description" content="一般来说要做一个抽奖程序会立即想到用随机数. 但是通常情况下随机数也不是那么的随机, 数量比较大的时候才能体现出比较平均, 数量较小的时候中奖概率的可控性将会很差. 一不小心多被抽中几个麻烦就大了.
&amp;lt;?php class T_prize{ var $item; var $table; /** * 抽奖主程序 外部调用入口 * @param unknown_type $db 数据库链接 * @param unknown_type $id 抽奖类型 */ function prize($db, $id){ global $prize_set; //  if(!isset($prize_set[$id])){ return false; } $this-&amp;gt;item = $prize_set[$id]; $table = &amp;#39;my_prize_store_table_&amp;#39; . $id; //抽奖并发较大时可以进行分表, 多生成几个奖池  //$table = &amp;#39;my_prize_store_table_&amp;#39; . $id . &amp;#39;_&amp;#39; . rand(0, 4);  $this-&amp;gt;table = $table; //防止多个用户抽到同一个条目, 进行锁表  $db-&amp;gt;query(&amp;#34;lock table &amp;#34; . $table .">
<meta property="og:url" content="https://hitian.info/post/lottery-simulation/">
<meta property="og:site_name" content="不折腾不舒服">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="php"><meta property="article:tag" content="lottery"><meta property="article:published_time" content="2011-11-23T00:00:00+00:00"><meta property="article:modified_time" content="2011-11-23T00:00:00+00:00">
<meta name=twitter:title content="使用类似于奖池方式的抽奖模拟">
<meta name=twitter:description content="一般来说要做一个抽奖程序会立即想到用随机数. 但是通常情况下随机数也不是那么的随机, 数量比较大的时候才能体现出比较平均, 数量较小的时候中奖概率的可控性将会很差. 一不小心多被抽中几个麻烦就大了.
&amp;lt;?php class T_prize{ var $item; var $table; /** * 抽奖主程序 外部调用入口 * @param unknown_type $db 数据库链接 * @param unknown_type $id 抽奖类型 */ function prize($db, $id){ global $prize_set; //  if(!isset($prize_set[$id])){ return false; } $this-&amp;gt;item = $prize_set[$id]; $table = &amp;#39;my_prize_store_table_&amp;#39; . $id; //抽奖并发较大时可以进行分表, 多生成几个奖池  //$table = &amp;#39;my_prize_store_table_&amp;#39; . $id . &amp;#39;_&amp;#39; . rand(0, 4);  $this-&amp;gt;table = $table; //防止多个用户抽到同一个条目, 进行锁表  $db-&amp;gt;query(&amp;#34;lock table &amp;#34; . $table .">
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-24477176-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.body.dataset.scheme='dark':document.body.dataset.scheme='light'})()</script><div class="container main-container flex on-phone--column extended article-page with-toolbar">
<aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header class=site-info>
<figure class=site-avatar>
<img src=/assets/avatar.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
<span class=emoji>🌎</span>
</figure>
<h1 class=site-name><a href=https://hitian.info>不折腾不舒服</a></h1>
<h2 class=site-description>折腾笔记</h2>
</header>
<ol class=menu id=main-menu>
<li>
<a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span>
</a>
</li>
<li>
<a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span>
</a>
</li>
<li>
<a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span>
</a>
</li>
<li>
<a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span>
</a>
</li>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span>
</li>
</ol>
</aside>
<main class="main full-width">
<div id=article-toolbar>
<a href=https://hitian.info class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=/categories/php/>
php
</a>
</header>
<h2 class=article-title>
<a href=/post/lottery-simulation/>使用类似于奖池方式的抽奖模拟</a>
</h2>
<footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--published>Nov 23, 2011</time>
</footer></div>
</header>
<section class=article-content>
<p>一般来说要做一个抽奖程序会立即想到用随机数. 但是通常情况下随机数也不是那么的随机, 数量比较大的时候才能体现出比较平均, 数量较小的时候中奖概率的可控性将会很差. 一不小心多被抽中几个麻烦就大了.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php>

<span class=o>&lt;?</span><span class=nx>php</span>
<span class=k>class</span> <span class=nc>T_prize</span><span class=p>{</span>
    <span class=k>var</span> <span class=nv>$item</span><span class=p>;</span>
    <span class=k>var</span> <span class=nv>$table</span><span class=p>;</span>
 
<span class=sd>/**
</span><span class=sd> * 抽奖主程序 外部调用入口
</span><span class=sd> * @param unknown_type $db 数据库链接
</span><span class=sd> * @param unknown_type $id 抽奖类型
</span><span class=sd> */</span>
     <span class=k>function</span> <span class=nf>prize</span><span class=p>(</span><span class=nv>$db</span><span class=p>,</span> <span class=nv>$id</span><span class=p>){</span>
         <span class=k>global</span> <span class=nv>$prize_set</span><span class=p>;</span>
        <span class=c1>//
</span><span class=c1></span>         <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$prize_set</span><span class=p>[</span><span class=nv>$id</span><span class=p>])){</span>
             <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
         <span class=p>}</span>
         <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>item</span> <span class=o>=</span> <span class=nv>$prize_set</span><span class=p>[</span><span class=nv>$id</span><span class=p>];</span>
         <span class=nv>$table</span> <span class=o>=</span> <span class=s1>&#39;my_prize_store_table_&#39;</span> <span class=o>.</span> <span class=nv>$id</span><span class=p>;</span>
         <span class=c1>//抽奖并发较大时可以进行分表, 多生成几个奖池
</span><span class=c1></span>         <span class=c1>//$table = &#39;my_prize_store_table_&#39; . $id . &#39;_&#39; . rand(0, 4);
</span><span class=c1></span>         <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>table</span> <span class=o>=</span> <span class=nv>$table</span><span class=p>;</span>
         <span class=c1>//防止多个用户抽到同一个条目, 进行锁表
</span><span class=c1></span>         <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s2>&#34;lock table &#34;</span> <span class=o>.</span> <span class=nv>$table</span> <span class=o>.</span> <span class=s2>&#34; write&#34;</span><span class=p>);</span>
         <span class=nv>$pid</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>get_one</span><span class=p>(</span><span class=nv>$db</span><span class=p>,</span> <span class=nv>$id</span><span class=p>);</span>
         <span class=c1>//奖池中没有奖品时重新初始化奖池
</span><span class=c1></span>         <span class=k>if</span><span class=p>(</span><span class=nv>$pid</span> <span class=o>==</span> <span class=s1>&#39;-1&#39;</span><span class=p>){</span>
             <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>create_pool</span><span class=p>(</span><span class=nv>$db</span><span class=p>,</span> <span class=nv>$id</span><span class=p>);</span>
             <span class=nv>$pid</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>get_one</span><span class=p>(</span><span class=nv>$db</span><span class=p>,</span> <span class=nv>$id</span><span class=p>);</span>
         <span class=p>}</span>
         <span class=c1>//释放锁 返回抽奖结果
</span><span class=c1></span>         <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s2>&#34;unlock table&#34;</span><span class=p>);</span>
         <span class=k>return</span> <span class=nv>$pid</span><span class=p>;</span>
      <span class=p>}</span>
 
<span class=sd>/**
</span><span class=sd>  * 抽奖一次
</span><span class=sd>  * @param unknown_type $db
</span><span class=sd>  * @param unknown_type $id
</span><span class=sd>  */</span>
     <span class=k>function</span> <span class=nf>get_one</span><span class=p>(</span><span class=nv>$db</span><span class=p>,</span> <span class=nv>$id</span><span class=p>){</span>
         <span class=nv>$table</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>table</span><span class=p>;</span>
         <span class=nv>$sql</span> <span class=o>=</span> <span class=s2>&#34;SELECT * FROM </span><span class=si>${</span><span class=nv>table</span><span class=si>}</span><span class=s2> WHERE enable = &#39;1&#39; LIMIT 1&#34;</span><span class=p>;</span>
         <span class=nv>$row</span> <span class=o>=</span> <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>fetch</span><span class=p>(</span><span class=nv>$db</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=nv>$sql</span><span class=p>));</span>
         <span class=nv>$success</span> <span class=o>=</span> <span class=k>false</span><span class=p>;</span>
         <span class=nv>$re</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
         <span class=k>if</span><span class=p>(</span><span class=nv>$row</span><span class=p>){</span>
             <span class=nv>$id</span> <span class=o>=</span> <span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>];</span>
             <span class=nv>$pid</span> <span class=o>=</span> <span class=nv>$row</span><span class=p>[</span><span class=s1>&#39;pid&#39;</span><span class=p>];</span>
             <span class=nv>$update_data</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
                 <span class=s1>&#39;enable&#39;</span> <span class=o>=&gt;</span> <span class=mi>0</span><span class=p>,</span>
             <span class=p>);</span>
             <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>update</span><span class=p>(</span><span class=nv>$table</span><span class=p>,</span> <span class=nv>$update_data</span><span class=p>,</span> <span class=s2>&#34;id=&#39;</span><span class=si>$id</span><span class=s2>&#39;&#34;</span><span class=p>);</span>
             <span class=nv>$result</span> <span class=o>=</span> <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>getAffectedRows</span><span class=p>();</span>
             <span class=k>if</span><span class=p>(</span><span class=nv>$result</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
                 <span class=nv>$success</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
                 <span class=nv>$re</span> <span class=o>=</span> <span class=nv>$row</span><span class=p>;</span>
             <span class=p>}</span><span class=k>else</span><span class=p>{</span>
                 <span class=nx>my_log</span><span class=p>(</span><span class=s1>&#39;抽奖池条目状态修改发生错误 id:&#39;</span> <span class=o>.</span> <span class=nv>$id</span><span class=p>);</span>
             <span class=p>}</span>
         <span class=p>}</span><span class=k>else</span><span class=p>{</span>
             <span class=k>return</span> <span class=s1>&#39;-1&#39;</span><span class=p>;</span>
         <span class=p>}</span>
         <span class=k>if</span><span class=p>(</span><span class=nv>$success</span><span class=p>){</span>
             <span class=k>return</span> <span class=nv>$pid</span><span class=p>;</span>
         <span class=p>}</span><span class=k>else</span><span class=p>{</span>
             <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
         <span class=p>}</span>
     <span class=p>}</span>
 
<span class=sd>/**
</span><span class=sd>  * 奖品池初始化
</span><span class=sd>  * @param unknown_type $db
</span><span class=sd>  * @param unknown_type $id
</span><span class=sd>  */</span>
     <span class=k>function</span> <span class=nf>create_pool</span><span class=p>(</span><span class=nv>$db</span><span class=p>,</span> <span class=nv>$id</span><span class=p>){</span>
         <span class=nv>$table</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>table</span><span class=p>;</span>
         <span class=nx>my_log</span><span class=p>(</span><span class=s1>&#39;init prize pool id:&#39;</span> <span class=o>.</span> <span class=nv>$id</span><span class=p>);</span>
         <span class=nv>$item</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>item</span><span class=p>;</span>
         <span class=nv>$total_num</span> <span class=o>=</span> <span class=nv>$item</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>];</span>
         <span class=nv>$list</span> <span class=o>=</span> <span class=nv>$item</span><span class=p>[</span><span class=s1>&#39;list&#39;</span><span class=p>];</span>
         <span class=nv>$tprize_list</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
         <span class=k>foreach</span> <span class=p>(</span><span class=nv>$list</span> <span class=k>as</span> <span class=nv>$key</span><span class=o>=&gt;</span><span class=nv>$one</span><span class=p>){</span>
             <span class=nv>$tnum</span> <span class=o>=</span> <span class=nx>intval</span><span class=p>(</span><span class=nv>$total_num</span> <span class=o>*</span> <span class=nv>$one</span><span class=p>[</span><span class=s1>&#39;probability&#39;</span><span class=p>]);</span>
             <span class=k>if</span><span class=p>(</span><span class=nv>$tnum</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>){</span>
                 <span class=nx>my_log</span><span class=p>(</span><span class=s1>&#39;create prize pool create alert: total_num:&#39;</span> <span class=o>.</span> <span class=nv>$total_num</span> <span class=o>.</span> <span class=s1>&#39; item_name:&#39;</span> <span class=o>.</span> <span class=nv>$item</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=o>.</span> <span class=s1>&#39; probability:&#39;</span> <span class=o>.</span> <span class=nv>$item</span><span class=p>[</span><span class=s1>&#39;probability&#39;</span><span class=p>]);</span>
                 <span class=k>continue</span><span class=p>;</span>
             <span class=p>}</span>
             <span class=k>for</span> <span class=p>(</span><span class=nv>$i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>&lt;</span> <span class=nv>$tnum</span><span class=p>;</span> <span class=nv>$i</span> <span class=o>++</span><span class=p>){</span>
                 <span class=k>do</span><span class=p>{</span>
                     <span class=nv>$id</span> <span class=o>=</span> <span class=nx>rand</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>$total_num</span><span class=p>);</span>
                 <span class=p>}</span><span class=k>while</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$tprize_list</span><span class=p>[</span><span class=nv>$id</span><span class=p>]));</span>
                 <span class=nv>$tprize_list</span><span class=p>[</span><span class=nv>$id</span><span class=p>]</span> <span class=o>=</span> <span class=nv>$key</span><span class=p>;</span>
             <span class=p>}</span>
         <span class=p>}</span>
         <span class=nx>my_log</span><span class=p>(</span><span class=s1>&#39;start&#39;</span><span class=p>);</span>
         <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=s1>&#39;TRUNCATE &#39;</span> <span class=o>.</span> <span class=nv>$table</span><span class=p>);</span>
         <span class=nv>$insert_str_arr</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
         <span class=k>for</span><span class=p>(</span><span class=nv>$i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> <span class=nv>$i</span><span class=o>&lt;=</span><span class=nv>$total_num</span><span class=p>;</span> <span class=nv>$i</span><span class=o>++</span><span class=p>){</span>
             <span class=nv>$this_pid</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
             <span class=nv>$inset_data</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;pid&#39;</span><span class=o>=&gt;</span><span class=mi>0</span><span class=p>);</span>
              <span class=k>if</span><span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$tprize_list</span><span class=p>[</span><span class=nv>$i</span><span class=p>])){</span>
                  <span class=nv>$this_pid</span> <span class=o>=</span> <span class=nv>$tprize_list</span><span class=p>[</span><span class=nv>$i</span><span class=p>];</span>
              <span class=p>}</span>
              <span class=c1>//每100条记录插入一次可以大幅减小数据库插入时间时间
</span><span class=c1></span>              <span class=nv>$insert_str_arr</span><span class=p>[]</span> <span class=o>=</span> <span class=s2>&#34;(</span><span class=si>$this_pid</span><span class=s2>)&#34;</span><span class=p>;</span>
              <span class=k>if</span><span class=p>(</span><span class=nv>$i</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>){</span>
                  <span class=nv>$insert_str</span> <span class=o>=</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=nv>$insert_str_arr</span><span class=p>);</span>
                  <span class=nv>$insert_str</span> <span class=o>=</span> <span class=s1>&#39;insert into &#39;</span> <span class=o>.</span> <span class=nv>$table</span> <span class=o>.</span> <span class=s1>&#39;(pid) values&#39;</span> <span class=o>.</span> <span class=nv>$insert_str</span><span class=p>;</span>
                  <span class=nv>$db</span><span class=o>-&gt;</span><span class=na>query</span><span class=p>(</span><span class=nv>$insert_str</span><span class=p>);</span>
                  <span class=nv>$insert_str_arr</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
             <span class=p>}</span>
         <span class=p>}</span>
         <span class=nx>my_log</span><span class=p>(</span><span class=s1>&#39;end&#39;</span><span class=p>);</span>
     <span class=p>}</span>
 
  <span class=p>}</span>
 
  <span class=c1>//自定义日志
</span><span class=c1></span>  <span class=k>function</span> <span class=nf>my_log</span><span class=p>(</span><span class=nv>$msg</span><span class=p>){</span>
    <span class=c1>//write logs here
</span><span class=c1></span>  <span class=p>}</span>

</code></pre></div><p>使用奖池的概念可以将中奖概率严格限制一下,  生成一定数量的格子, 按照概率算出有奖品的格子的数量, 然后再随机填充到格子里去, 执行抽奖的时候一次去打开格子. 要么中奖,要么不中, 当所有格子都被开启过之后,  再次执行初始化重新填充所有的格子.
设置一下需要使用的奖品数据和概率</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php>
<span class=o>&lt;?</span><span class=nx>php</span>
<span class=nv>$prize_set</span> <span class=o>=</span> <span class=k>array</span><span class=p>();</span>
<span class=c1>//抽奖1
</span><span class=c1></span><span class=nv>$prize_set</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
   <span class=s1>&#39;total&#39;</span> <span class=o>=&gt;</span> <span class=mi>1000</span><span class=p>,</span>
   <span class=s1>&#39;list&#39;</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span>
        <span class=mi>1</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品1&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.01&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>3</span><span class=p>),</span>
        <span class=mi>2</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品2&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.05&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>7</span><span class=p>),</span>
        <span class=mi>3</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品3&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.1&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>9</span><span class=p>),</span>
    <span class=p>),</span>
 <span class=p>);</span>
 
 <span class=c1>//抽奖2
</span><span class=c1></span> <span class=nv>$prize_set</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
     <span class=s1>&#39;total&#39;</span> <span class=o>=&gt;</span> <span class=mi>1000</span><span class=p>,</span>
     <span class=s1>&#39;list&#39;</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span>
        <span class=mi>1</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品1&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.001&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>3</span><span class=p>),</span>
        <span class=mi>2</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品2&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.005&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>7</span><span class=p>),</span>
        <span class=mi>3</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品3&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.01&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>9</span><span class=p>),</span>
        <span class=mi>4</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品4&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.02&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>1</span><span class=p>),</span>
        <span class=mi>5</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品5&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.05&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>2</span><span class=p>),</span>
        <span class=mi>6</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;奖品6&#39;</span><span class=p>,</span> <span class=s1>&#39;probability&#39;</span><span class=o>=&gt;</span> <span class=s1>&#39;0.1&#39;</span><span class=p>,</span> <span class=s1>&#39;product_id&#39;</span> <span class=o>=&gt;</span> <span class=mi>4</span><span class=p>),</span>
    <span class=p>),</span>
<span class=p>);</span>

</code></pre></div><p>我有两组抽奖, 所以定义了两组.  注意, 每组的总数 乘以 这组中最小的一个概率一定要大于1,  不然这个奖品就永远也没可能抽中了.</p>
<p>这种方式也有缺点:</p>
<p>1.概率的调整只能在下次奖池初始化时才能生效,</p>
<p>2.使用数据库表锁来保证同一个格子只能被一个人抽中, 会导致性能降低, (我们使用的是myisam, 只能使用表级锁)无法支持大量的并发, 有个很笨的但最简单的解决方案就是对同一个抽奖使用多个奖池, 将请求分散到各个表去.</p>
<p>后记:表在lock 状态中实际上是不支持truncate 操作的,  先delete from table 删除所有数据, 再 alter table xxx set auto_increment=1  就可以解决这个问题&mldr;</p>
</section>
<footer class=article-footer>
<section class=article-tags>
<a href=/tags/php/>php</a>
<a href=/tags/lottery/>lottery</a>
</section>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
<h2 class=section-title>相关文章</h2>
<div class=related-contents>
<div class="flex article-list--tile">
<article>
<a href=/post/sql-injection-risk/>
<div class=article-details>
<h2 class=article-title>注入风险提醒</h2>
</div>
</a>
</article>
<article>
<a href=/post/php-file-download-set-header/>
<div class=article-details>
<h2 class=article-title>php 文件下载 header 设置</h2>
</div>
</a>
</article>
<article>
<a href=/post/win7-x64-zend-studio-x86/>
<div class=article-details>
<h2 class=article-title>win7 x64 运行x86的zend studio 9.0</h2>
</div>
</a>
</article>
<article>
<a href=/post/php-exec/>
<div class=article-details>
<h2 class=article-title>php执行服务器脚本</h2>
</div>
</a>
</article>
<article>
<a href=/post/php-regex-length-limit/>
<div class=article-details>
<h2 class=article-title>php注意正则匹配的长度限制</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//hitian.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2011 -
2021 不折腾不舒服
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.3.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>